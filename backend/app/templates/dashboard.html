<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard</title>
  <link rel="stylesheet" href="/static/css/dashboard.css" />
</head>
<body>
  
<nav class="navbar">
  <div class="nav-left" onclick="location.href='/dashboard'">
    ğŸ€„ éº»å°‡æˆ°ç¸¾
  </div>

  <div class="nav-right">
    <button class="nav-report-btn" onclick="openReport()">
      å»ºè­°/å›é¥‹
    </button>

    <div class="avatar" onclick="toggleUserMenu()">ğŸ‘¤</div>

    <div class="user-menu" id="userMenu">
      <button onclick="logout()">ç™»å‡º</button>
    </div>
  </div>
</nav>


</nav>
  <header class="header">
    <h2>2026 éº»å°‡æˆ°ç¸¾</h2>
  </header>

  <section class="cards">
    <div class="card pink">
      <p>å¹´åº¦ç¸½æç›Š</p>
      <h3 id="totalProfit">-</h3>
    </div>

    <div class="card blue">
      <p>å‹å ´ç¸½æ”¶ç›Š</p>
      <h3 id="winProfit">-</h3>
    </div>

    <div class="card beige">
      <p>æ•—å ´ç¸½æ”¯å‡º</p>
      <h3 id="loseProfit">-</h3>
    </div>

    <div class="card dice">
      <p>ç´¯ç©å°‡æ•¸</p>
      <h3 id="totalRounds">-</h3>
    </div>
  </section>

    <section class="calendar">

    <div class="cal-head">
    <button class="nav-btn" onclick="prevMonth()">â€¹</button>
    <h3 id="calTitle"></h3>
    <button class="nav-btn" onclick="nextMonth()">â€º</button>
    </div>

    <!-- æ˜ŸæœŸæ¨™é¡Œ -->
    <div class="dow">
        <div>æ—¥</div><div>ä¸€</div><div>äºŒ</div><div>ä¸‰</div><div>å››</div><div>äº”</div><div>å…­</div>
    </div>

    <!-- æœˆæ›†æ ¼å­ç”± JS ç”Ÿæˆ -->
    <div class="grid" id="calendarGrid"></div>
    </section>
  <button class="fab" onclick="openModal()">ï¼‹</button>

<div id="reportModal" class="report-overlay">
  <div class="report-modal">
    <div class="report-header">
      <h2>å•é¡Œå›å ±</h2>
      <button class="report-close" onclick="closeReport()">âœ•</button>
    </div>

    <textarea
      id="reportContent"
      class="report-textarea"
      placeholder="è«‹æè¿°ä½ é‡åˆ°çš„å•é¡Œæˆ–æ˜¯æœ‰ä»»ä½•å»ºè­°"
    ></textarea>

    <div class="report-actions">
      <button class="btn-cancel" onclick="closeReport()">å–æ¶ˆ</button>
      <button class="btn-submit" onclick="submitReport()">é€å‡º</button>
    </div>
  </div>
</div>

<!-- æ–°å¢å°å±€ Modal -->
<div class="modal" id="sessionModal">
  <div class="modal-content">
    <button class="close" onclick="closeModal()">âœ•</button>

    <h2>æ–°å¢å°å±€</h2>

    <label>æ—¥æœŸ</label>
    <input type="date" id="date" required />

    <label>ç‰Œå‹</label>
    <input type="text" placeholder="è¼¸å…¥äººå“¡å§“å" id="players" required />

    <label>å°æ•¸</label>
    <div class="stakes" id="stakes">
    <button type="button" class="stake-btn" data-stake="30/10" onclick="selectStake(this)">30/10</button>
    <button type="button" class="stake-btn" data-stake="50/20" onclick="selectStake(this)">50/20</button>
    <button type="button" class="stake-btn" data-stake="100/20" onclick="selectStake(this)">100/20</button>

    </div>

    <label>åœ°é»</label>
    <input type="text" placeholder="åœ°é»" id="location" required />

    <label>å°‡æ•¸</label>
    <input type="number" placeholder="å°‡æ•¸" id="rounds" required />

    <label>æœ¬å±€çµæœ</label>
    <input
    type="number"
    id="profit"
    placeholder="è´å¡«æ­£æ•¸ï¼Œè¼¸å¡«è² æ•¸ï¼Œä¾‹å¦‚ï¼š800 æˆ– -300"
    required 
    />

    <button class="save" onclick="saveSession()">å„²å­˜</button>
  </div>
</div>

<!-- ç•¶æ—¥å°å±€æ¸…å–® Modal -->
<div class="modal" id="dayModal">
  <div class="modal-content">
    <button class="close" onclick="closeDayModal()">âœ•</button>

    <h2 id="dayModalTitle">ç•¶æ—¥å°å±€</h2>

    <div id="daySessionList"></div>

    <button class="save" onclick="openAddFromDay()">ï¼‹ æ–°å¢å°å±€</button>
  </div>
</div>

<script>

function openReport() {
  document.getElementById("reportModal").style.display = "flex";
}

function closeReport() {
  document.getElementById("reportModal").style.display = "none";
}

function submitReport() {
  const content = document.getElementById("reportContent").value;
  if (!content) {
    alert("ä½ è‡³å°‘æ‰“é»å­—");
    return;
  }

  fetch("/api/report", {
    method: "POST",
    credentials: "include",   // â­â­â­ é—œéµåœ¨é€™ä¸€è¡Œ
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ content })
  })
  .then(res => {
    if (!res.ok) throw new Error("send failed");
    return res.json();
  })
  .then(() => {
    alert("å·²é€å‡º");
    closeReport();
  })
  .catch(() => {
    alert("é€å‡ºå¤±æ•—ï¼Œè«‹é‡æ–°ç™»å…¥å¾Œå†è©¦");
  });
}

function toggleUserMenu() {
  const menu = document.getElementById("userMenu");
  menu.style.display = menu.style.display === "block" ? "none" : "block";
}

function logout() {
  fetch("/auth/google/logout", {
    method: "POST",
    credentials: "include", // â­ å¾ˆé‡è¦
  })
  .then(res => {
    if (!res.ok) throw new Error("logout failed");
    // â­ ç™»å‡ºæˆåŠŸå¾Œï¼Œå‰ç«¯è‡ªå·±è·³é 
    window.location.href = "/";
  })
  .catch(err => {
    console.error(err);
    alert("ç™»å‡ºå¤±æ•—");
  });
}

/* =====================
   Modal é–‹é—œ
===================== */
function openModal() {
  document.getElementById("sessionModal").style.display = "flex";
}

function closeModal() {
  editingSessionId = null;
  document.getElementById("sessionModal").style.display = "none";
}

/* =====================
   å°æ•¸é¸æ“‡ï¼ˆå–®é¸ï¼‰
===================== */
let selectedStake = null;

function selectStake(btn) {
  document
    .querySelectorAll(".stake-btn")
    .forEach(b => b.classList.remove("active"));
  btn.classList.add("active");
  selectedStake = btn.dataset.stake;
}

/* =====================
   æ–°å¢å°å±€ï¼ˆçœŸçš„å­˜ DBï¼‰
===================== */
function saveSession() {
  const payload = {
    date: document.getElementById("date").value,
    players: document.getElementById("players").value.trim(),
    stake: selectedStake,
    location: document.getElementById("location").value.trim(),
    rounds: Number(document.getElementById("rounds").value),
    profit: Number(document.getElementById("profit").value),
  };

  if (Number.isNaN(payload.profit)) {
    alert("è«‹è¼¸å…¥æœ¬å±€è¼¸è´é‡‘é¡ï¼ˆæ­£è² æ•¸ï¼‰");
    return;
  }

  if (!payload.date || !payload.players || !payload.stake || !payload.rounds) {
    alert("è«‹å¡«å¯«å®Œæ•´è³‡æ–™");
    return;
  }

  // â­â­ é—œéµï¼šåˆ¤æ–·æ–°å¢ or ç·¨è¼¯
  const isEdit = editingSessionId !== null;
  const url = isEdit
    ? `/api/sessions/${editingSessionId}`
    : "/api/sessions";

  const method = isEdit ? "PUT" : "POST";

  fetch(url, {
    method,
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload),
  })
    .then(res => {
      if (!res.ok) throw new Error("å„²å­˜å¤±æ•—");
      return res.json();
    })
    .then(() => {
      editingSessionId = null;      // â­ é‡ç½®ç‹€æ…‹
      closeModal();
      reloadDashboard();
    })
    .catch(err => {
      console.error(err);
      alert("å„²å­˜å¤±æ•—ï¼Œè«‹å†è©¦ä¸€æ¬¡");
    });
}


/* =====================
   Dashboard é‡æ•´å…¥å£
===================== */
function reloadDashboard() {
  loadSummary();
  reloadCalendar();
}

/* =====================
   è¼‰å…¥å¹´åº¦ç¸½è¦½å¡ç‰‡
===================== */
function loadSummary() {
  fetch(`/api/sessions/summary?year=${YEAR}`)
    .then(res => res.json())
    .then(data => {
      document.getElementById("totalProfit").textContent =
        data.total_profit ?? "-";

      document.getElementById("winProfit").textContent =
        data.win_profit ?? "-";

      document.getElementById("loseProfit").textContent =
        data.lose_profit ?? "-";

      document.getElementById("totalRounds").textContent =
        data.total_rounds ?? "-";
    });
}

let currentDate = new Date();   // â­ å¿…é ˆå­˜åœ¨
let YEAR, MONTH;

function syncYM() {
  YEAR = currentDate.getFullYear();
  MONTH = currentDate.getMonth() + 1; // JS æœˆä»½ 0â€“11
}
function prevMonth() {
  currentDate.setMonth(currentDate.getMonth() - 1);
  syncYM();
  reloadCalendar();
  updateCalTitle();
  reloadDashboard();   

}
function nextMonth() {
  currentDate.setMonth(currentDate.getMonth() + 1);
  syncYM();
  reloadCalendar();
  updateCalTitle();
  reloadDashboard();   
}
function updateCalTitle() {
  document.getElementById("calTitle").textContent =
    `${YEAR} å¹´ ${MONTH} æœˆ`;
}
function pad2(n){ return String(n).padStart(2,"0"); }
function ymd(y,m,d){ return `${y}-${pad2(m)}-${pad2(d)}`; }

/* ===== ç”¢ç”Ÿæœˆæ›†éª¨æ¶ ===== */
function renderCalendarSkeleton(year, month){
  const grid = document.getElementById("calendarGrid");
  grid.innerHTML = "";


  const firstDay = new Date(year, month-1, 1);
  const firstDow = firstDay.getDay(); // 0=æ—¥
  const daysInMonth = new Date(year, month, 0).getDate();

  // å‰é¢ç©ºç™½
  for(let i=0;i<firstDow;i++){
    const e = document.createElement("div");
    e.className = "day empty";
    grid.appendChild(e);
  }

  // æ—¥æœŸæ ¼
  for(let d=1; d<=daysInMonth; d++){
    const cell = document.createElement("div");
    cell.className = "day";
    cell.dataset.date = ymd(year,month,d);

    cell.innerHTML = `
      <div class="num">${d}</div>
      <div class="amt"></div>
    `;

    cell.addEventListener("click", ()=>{
        onDayClick(cell.dataset.date);
    });

    grid.appendChild(cell);
  }
}

/* ===== å¾ DB å¥—è³‡æ–™ ===== */
async function loadCalendarData(year, month){
  const res = await fetch("/api/sessions");
  const sessions = await res.json();

  const start = `${year}-${pad2(month)}-01`;
  const end = `${year}-${pad2(month)}-${pad2(new Date(year,month,0).getDate())}`;

  const daily = {};

  sessions.forEach(s=>{
    if(s.date>=start && s.date<=end){
      daily[s.date] = (daily[s.date]||0) + Number(s.profit);
    }
  });

  document.querySelectorAll(".day").forEach(cell=>{
    const dt = cell.dataset.date;
    if(!dt) return;

    const amt = cell.querySelector(".amt");
    cell.classList.remove("has-record","lose");
    amt.textContent = "";

    if(daily[dt]!=null){
      const p = daily[dt];
      amt.textContent = (p>0?"+":"") + p;

      if(p>=0) cell.classList.add("has-record");
      else cell.classList.add("lose");
    }
  });
}

async function reloadCalendar(){
  renderCalendarSkeleton(YEAR,MONTH);
  await loadCalendarData(YEAR,MONTH);
}

function onDayClick(date) {
  fetch(`/api/sessions?date=${date}`)
    .then(res => res.json())
    .then(list => {
      if (list.length === 0) {
        // æ²’è³‡æ–™ â†’ ç›´æ¥æ–°å¢
        openModal();
        document.getElementById("date").value = date;
      } else {
        // æœ‰è³‡æ–™ â†’ é¡¯ç¤ºç•¶æ—¥æ¸…å–®
        openDayModal(date, list);
      }
    });
}

function openAddFromDay() {
  closeDayModal();
  openModal();
  document.getElementById("date").value = currentDay;
}

let currentDay = null;

function openDayModal(date, sessions) {
  currentDay = date;

  document.getElementById("dayModalTitle").textContent = `${date} å°å±€ç´€éŒ„`;

  const list = document.getElementById("daySessionList");
  list.innerHTML = "";

  sessions.forEach((s, i) => {
    const item = document.createElement("div");
    item.className = "day-session-item";
    item.innerHTML = `
    <div class="session-row">
        <div class="session-info">
        <div>ç¬¬ ${i+1} å±€</div>
        <div>ç‰Œå‹ï¼š${s.players}</div>
        <div>å°æ•¸ï¼š${s.stake}</div>
        <div>åœ°é»ï¼š${s.location || "-"}</div>
        <div>çµæœï¼š${s.profit > 0 ? "+" : ""}${s.profit}</div>
        </div>

        <div class="session-actions">
        <button onclick="editSession(${s.id})">âœï¸</button>
        <button onclick="deleteSession(${s.id})">ğŸ—‘</button>
        </div>
    </div>
    <hr/>
    `;
    list.appendChild(item);
  });

  document.getElementById("dayModal").style.display = "flex";
}

function closeDayModal() {
  document.getElementById("dayModal").style.display = "none";
}

function deleteSession(id) {
  if (!confirm("ç¢ºå®šè¦åˆªé™¤é€™ä¸€å±€å—ï¼Ÿ")) return;

  fetch(`/api/sessions/${id}`, {
    method: "DELETE",
  })
  .then(res => {
    if (!res.ok) throw new Error("åˆªé™¤å¤±æ•—");
    return res.json();
  })
  .then(() => {
    closeDayModal();
    reloadDashboard();
  })
  .catch(err => {
    console.error(err);
    alert("åˆªé™¤å¤±æ•—");
  });
}

let editingSessionId = null;

function editSession(id) {
  fetch(`/api/sessions/${id}`)
    .then(res => res.json())
    .then(s => {
      editingSessionId = id;

      openModal();

      document.getElementById("date").value = s.date;
      document.getElementById("players").value = s.players;
      document.getElementById("location").value = s.location || "";
      document.getElementById("rounds").value = s.rounds;
      document.getElementById("profit").value = s.profit;

      // é¸å°æ•¸
      document.querySelectorAll(".stake-btn").forEach(btn => {
        btn.classList.toggle("active", btn.dataset.stake === s.stake);
        if (btn.dataset.stake === s.stake) selectedStake = s.stake;
      });
    });
}

/* =====================
   é é¢åˆå§‹åŒ–
===================== */
syncYM();
updateCalTitle();
reloadCalendar();
reloadDashboard();   

</script>

</body>
</html>
